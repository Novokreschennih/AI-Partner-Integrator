
import { GoogleGenAI } from "@google/genai";
import { SimpleMessage } from '../lib/n8nConverter';

export interface GenerationResult {
  botProfile: {
    voiceTone: string;
    keyCharacteristics: string[];
  };
  customizedScript: SimpleMessage[];
  visualizationPrompts: {
    avatar: string;
    scenario: string;
  };
}


export async function generateRecommendations(
  botScript: string,
  partnerProducts: string,
  apiKey: string,
  temperature: number,
): Promise<string> {
  if (!apiKey) {
    throw new Error("API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.");
  }

  const ai = new GoogleGenAI({ apiKey });
  const model = 'gemini-2.5-flash';

  const prompt = `
–¢–≤–æ—è —Ä–æ–ª—å: AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –±—Ä–µ–Ω–¥-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ö –≤ —á–∞—Ç-–±–æ—Ç–∞—Ö.

**–ó–ê–î–ê–ß–ê:**
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–∞—Ç-–±–æ—Ç–∞ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö. –ó–∞—Ç–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –µ–¥–∏–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:
1.  **–ü—Ä–æ—Ñ–∏–ª—å –≥–æ–ª–æ—Å–∞ –±–æ—Ç–∞ (botProfile):** –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è –æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞.
2.  **–°—Ü–µ–Ω–∞—Ä–∏–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (customizedScript):** –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –æ—Ä–≥–∞–Ω–∏—á–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –ø—Ä–æ–¥—É–∫—Ç –≤ —Å—Ç–∏–ª–µ –±–æ—Ç–∞.
3.  **–ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (visualizationPrompts):** –¢–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–∞–≤–∞—Ç–∞—Ä–∞ –∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏ –∫ —Å—Ü–µ–Ω–∞—Ä–∏—é), —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∏–ª—é –±–æ—Ç–∞.

**–í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï:**

1.  **–°—Ü–µ–Ω–∞—Ä–∏–π —á–∞—Ç-–±–æ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∏–ª—è:**
    \`\`\`
    ${botScript}
    \`\`\`

2.  **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–∞—Ö:**
    \`\`\`
    ${partnerProducts}
    \`\`\`

**–ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –ì–ï–ù–ï–†–ê–¶–ò–ò:**

1.  **–ê–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è:** –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–∑—É—á–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–æ–Ω –≥–æ–ª–æ—Å–∞ (—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —é–º–æ—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π), –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç–º–æ–¥–∑–∏, –¥–ª–∏–Ω—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.

2.  **–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (customizedScript):**
    *   –ù–∞–ø–∏—à–∏ –Ω–æ–≤—ã–π, –∫–æ—Ä–æ—Ç–∫–∏–π –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –±–ª–æ–∫.
    *   –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –¢–û–ß–ù–û –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª –Ω–∞ —à–∞–≥–µ 1. –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –Ω–∞—Ç–∏–≤–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è, –∞ –Ω–µ —Ä–µ–∫–ª–∞–º–∞.
    *   –°—Ü–µ–Ω–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –º–∞—Å—Å–∏–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤, –≥–¥–µ –∫–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç - —ç—Ç–æ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    *   –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: \`{"text": "...", "buttons": [[{"text": "...", "url": "...", "callback_data": "..."}]]}\`.
    *   –ò—Å–ø–æ–ª—å–∑—É–π \`callback_data\` –¥–ª—è –∫–Ω–æ–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –≤—ã–∑—ã–≤–∞—Ç—å –¥–∞–ª—å–Ω–µ–π—à—É—é –ª–æ–≥–∏–∫—É –≤ –±–æ—Ç–µ.

3.  **–°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (visualizationPrompts):**
    *   **avatar:** –°–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç –¥–ª—è AI-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, Midjourney, DALL-E) –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞/–º–∞—Å–∫–æ—Ç–∞ —ç—Ç–æ–≥–æ –±–æ—Ç–∞. –ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º, –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ. –°—Ç–∏–ª—å: vector logo, minimalist, friendly mascot.
    *   **scenario:** –°–æ–∑–¥–∞–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –≤–∏–∑—É–∞–ª—å–Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ç–æ–±–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏. –ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ.

**–§–û–†–ú–ê–¢ –í–´–í–û–î–ê:**
–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–π JSON-–æ–±—ä–µ–∫—Ç. –ù–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ \`\`\`json\`\`\` –æ–±—ë—Ä—Ç–æ–∫.

**–°–¢–†–£–ö–¢–£–†–ê JSON-–û–ë–™–ï–ö–¢–ê:**
\`\`\`json
{
  "botProfile": {
    "voiceTone": "–ü—Ä–∏–º–µ—Ä: –î—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –Ω–µ–º–Ω–æ–≥–æ —à—É—Ç–ª–∏–≤—ã–π",
    "keyCharacteristics": ["–ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–º–æ–¥–∑–∏ üåä –∏ üèîÔ∏è", "–û–±—Ä–∞—â–∞–µ—Ç—Å—è –Ω–∞ '—Ç—ã'", "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ —è—Å–Ω—ã–µ"]
  },
  "customizedScript": [
    {
      "text": "–ö—Å—Ç–∞—Ç–∏, —Ä–∞–∑ —É–∂ –º—ã –≥–æ–≤–æ—Ä–∏–º –æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö, –º–æ–∏ –¥—Ä—É–∑—å—è —Å–¥–µ–ª–∞–ª–∏ —Å—É–ø–µ—Ä-—É–¥–æ–±–Ω—ã–π —Ä—é–∫–∑–∞–∫ Wanderer! üéí –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è –≥–æ—Ä. –•–æ—á–µ—à—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å?",
      "buttons": [
        [
          {"text": "–î–∞, –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ!", "url": "https://example-shop.com/wanderer-35l?ref=bot123"},
          {"text": "–ù–µ —Å–µ–π—á–∞—Å", "callback_data": "decline_wanderer_backpack"}
        ]
      ]
    }
  ],
  "visualizationPrompts": {
    "avatar": "A friendly, minimalist robot mascot for a travel planning chatbot, shaped like a location pin, waving hello. Vector logo, vibrant blue and orange colors, clean lines, on a white background.",
    "scenario": "Digital illustration of a cheerful cartoon backpack sitting on top of a mountain peak, waving a small flag. The style is clean, modern, and friendly, suitable for a chatbot interface."
  }
}
\`\`\`
`;

  try {
    const response = await ai.models.generateContent({
        model: model,
        contents: prompt,
        config: {
            temperature: temperature
        }
    });
    const text = response.text;
    if (!text) {
      throw new Error("AI returned an empty response.");
    }
    return text;
  } catch (error: any) {
    console.error("Error calling Gemini API:", error);
    if (error.message && error.message.includes('API key not valid')) {
      throw new Error("–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    }
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Gemini API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏.");
  }
}