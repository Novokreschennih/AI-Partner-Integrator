
import { GoogleGenAI } from "@google/genai";

export async function generateRecommendations(
  botScript: string,
  partnerProducts: string,
  apiKey: string
): Promise<string> {
  if (!apiKey) {
    throw new Error("API –∫–ª—é—á –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω.");
  }

  const ai = new GoogleGenAI({ apiKey });
  const model = 'gemini-2.5-flash';

  const prompt = `
–¢–≤–æ—è —Ä–æ–ª—å: AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —á–∞—Ç-–±–æ—Ç–æ–≤.

**–®–∞–≥ 1: –ê–Ω–∞–ª–∏–∑ –°—Ç–∏–ª—è**
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–∞—Ç-–±–æ—Ç–∞. –°–æ–∑–¥–∞–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π '–ø—Ä–æ—Ñ–∏–ª—å –≥–æ–ª–æ—Å–∞' —ç—Ç–æ–≥–æ –±–æ—Ç–∞. –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞: —É—Ä–æ–≤–µ–Ω—å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —é–º–æ—Ä–∞, —á–∞—Å—Ç–æ—Ç—É –∏ —Ç–∏–ø —ç–º–æ–¥–∑–∏, —Å—Ä–µ–¥–Ω—é—é –¥–ª–∏–Ω—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏ —Ñ—Ä–∞–∑—ã, –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–∞ '—Ç—ã' –∏–ª–∏ '–≤—ã').

–°—Ü–µ–Ω–∞—Ä–∏–π —á–∞—Ç-–±–æ—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:
\`\`\`
${botScript}
\`\`\`

**–®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –ü—Ä–æ–¥—É–∫—Ç–æ–≤**
–ò–∑—É—á–∏ —Å–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –∏—Ö –æ–ø–∏—Å–∞–Ω–∏—è. –ü–æ–π–º–∏ –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –∏ –¥–ª—è –∫–∞–∫–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –æ–Ω –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω.

–°–ø–∏—Å–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤:
\`\`\`
${partnerProducts}
\`\`\`

**–®–∞–≥ 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –°—Ü–µ–Ω–∞—Ä–∏—è**
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π, –∫–æ—Ä–æ—Ç–∫–∏–π –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞. –í —ç—Ç–æ–º –±–ª–æ–∫–µ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ: —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–ø–∏—Å–∞–Ω –¢–û–ß–ù–û –≤ —Ç–æ–º –∂–µ —Å—Ç–∏–ª–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –æ–ø—Ä–µ–¥–µ–ª–∏–ª –Ω–∞ –®–∞–≥–µ 1. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∑–≤—É—á–∞—Ç—å —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –µ–≥–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è, –∏—Å–∫—Ä–µ–Ω–Ω—è—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è, –∞ –Ω–µ —Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Ä–µ–∫–ª–∞–º–∞. –ü—Ä–µ–¥–ª–æ–∂–∏ –ª–æ–≥–∏—á–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —ç—Ç–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å "–ß–µ–º –µ—â–µ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å?" –∏–ª–∏ –∫–∞–∫ –Ω–æ–≤—ã–π –ø—É–Ω–∫—Ç –≤ –º–µ–Ω—é).

**–®–∞–≥ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –í—ã–≤–æ–¥–∞**
–°—Ñ–æ—Ä–º–∏—Ä—É–π —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥–æ–≤—ã–π –±–ª–æ–∫ –≤ –≤–∏–¥–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON-–º–∞—Å—Å–∏–≤–∞ –¥–ª—è n8n. –ö–∞–∂–¥—ã–π —É–∑–µ–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –∫–Ω–æ–ø–∫–∏ —Å –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–º–∏ —Å—Å—ã–ª–∫–∞–º–∏. –ù–∞–ø—Ä–∏–º–µ—Ä: [{"text": "–ö—Å—Ç–∞—Ç–∏, —Ä–∞–∑ —É–∂ –º—ã –≥–æ–≤–æ—Ä–∏–º –æ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–µ, –º–æ–∏ –¥—Ä—É–∑—å—è —Å–æ–∑–¥–∞–ª–∏ –ø–æ—Ç—Ä—è—Å–∞—é—â–∏–π –∫—É—Ä—Å –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏! üì∏ –•–æ—á–µ—à—å –≤–∑–≥–ª—è–Ω—É—Ç—å?", "buttons": [[{"text": "–î–∞, –ø–æ–∫–∞–∂–∏!", "url": "https://–ø–∞—Ä—Ç–Ω—ë—Ä–∫–∞.—Ä—É/—Ñ–æ—Ç–æ–∫—É—Ä—Å?ref=123"}]]}]. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —ç—Ç–æ—Ç JSON-–º–∞—Å—Å–∏–≤ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –ø—Ä–µ–∞–º–±—É–ª –∏–ª–∏ \`\`\`json\`\`\` –æ–±–µ—Ä—Ç–æ–∫. –ü—Ä–æ—Å—Ç–æ —Å—ã—Ä–æ–π JSON-–º–∞—Å—Å–∏–≤ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏.
`;

  try {
    const response = await ai.models.generateContent({
        model: model,
        contents: prompt,
    });
    return response.text;
  } catch (error: any) {
    console.error("Error calling Gemini API:", error);
    if (error.message && error.message.includes('API key not valid')) {
      throw new Error("–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π API –∫–ª—é—á. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –µ–≥–æ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
    }
    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Gemini API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –∫–ª—é—á–∞ –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏.");
  }
}
